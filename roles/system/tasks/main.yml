---
- name: Set time zone.
  ansible.builtin.file:
    src: "/usr/share/zoneinfo/{{ system_region }}/{{ system_city }}"
    dest: /etc/localtime
    state: link

- name: Set locale-gen localization.
  ansible.builtin.lineinfile:
    dest: /etc/locale.gen
    regexp: "^{{ system_locale }}.UTF-8 UTF-8"
    insertafter: "^#{{ system_locale }}.UTF-8 UTF-8"
    line: "{{ system_locale }}.UTF-8 UTF-8"
    state: present
  notify: Run locale-gen.

- name: Set locale.conf localization.
  ansible.builtin.lineinfile:
    dest: /etc/locale.conf
    regexp: "^LANG={{ system_locale }}.UTF-8"
    line: "LANG={{ system_locale }}.UTF-8"
    state: present

- name: Set hostname.
  ansible.builtin.lineinfile:
    dest: /etc/hostname
    regexp: "^{{ system_hostname }}"
    line: "{{ system_hostname }}"
    state: present
  tags: [ molecule-notest ]

- name: Install zsh.
  become: true
  community.general.pacman:
    name: zsh
    state: present
  when: |
    system_user is defined and system_user | length > 0
    and system_pass is defined and system_pass | length > 0

- name: System user.
  ansible.builtin.user:
    name: "{{ system_user }}"
    shell: /bin/zsh
    groups: "{{ system_groups }}"
    state: present
    update_password: on_create
  when: |
    system_user is defined and system_user | length > 0
    and system_pass is defined and system_pass | length > 0

- name: Install openssh.
  become: true
  community.general.pacman:
    name: openssh
    state: present
  when: system_installed_keys | length > 0

- name: System user ssh keys.
  ansible.builtin.user:
    name: "{{ system_user }}"
    generate_ssh_key: true
    ssh_key_bits: 2048
    ssh_key_file: ".ssh/{{ item }}"
  loop: "{{ system_installed_keys }}"
  when: system_installed_keys | length > 0
